/* @license GPL-2.0-or-later https://www.drupal.org/licensing/faq */
(function($,Drupal){Drupal.behaviors.focalPointIndicator={attach(context){once("focal-point-hide-field",".focal-point",context).forEach(function(el){const $wrapper=$(el).closest(".focal-point-wrapper");if(!$(el).hasClass("error")){$wrapper.addClass("visually-hidden");$(el).on("focus",function(){$wrapper.removeClass("visually-hidden");}).on("blur",function(){$wrapper.addClass("visually-hidden");});}});once("focal-point-hide-field",".focal-point-indicator",context).forEach(function(el){const $indicator=$(el);const $img=$(el).siblings("img");const $previewLink=$(el).siblings(".focal-point-preview-link");const $field=$(`.${$(el).attr("data-selector")}`);const fp=new Drupal.FocalPoint($indicator,$img,$field,$previewLink);setTimeout(function(){$img.one("load",function(){fp.setIndicator();}).each(function(){if(this.complete)$(this).trigger("load");});},0);});}};Drupal.FocalPoint=function($indicator,$img,$field,$previewLink){const self=this;this.$indicator=$indicator;this.$img=$img;this.$field=$field;this.$previewLink=$previewLink;this.$indicator.draggable({containment:self.$img,stop(){const imgOffset=self.$img.offset();const focalPointOffset=self.$indicator.offset();const leftDelta=focalPointOffset.left-imgOffset.left;const topDelta=focalPointOffset.top-imgOffset.top;self.set(leftDelta,topDelta);}});this.$indicator.on("dblclick",function(){self.$field.closest(".focal-point-wrapper").toggleClass("visually-hidden");});this.$img.on("click",function(event){self.set(event.offsetX,event.offsetY);});this.$img.css("cursor","crosshair");this.$field.on("change",function(){$(document).trigger("drupalFocalPointSet",{$focalPoint:self});});this.$indicator.add(this.$img).add(this.$previewLink).wrapAll("<div class='focal-point-wrapper' />");};Drupal.FocalPoint.prototype.set=function(offsetX,offsetY){const focalPoint=this.calculate(offsetX,offsetY);this.$field.val(`${focalPoint.x},${focalPoint.y}`).trigger("change");$(document).trigger("drupalFocalPointSet",{$focalPoint:this});};Drupal.FocalPoint.prototype.setIndicator=function(){const coordinates=this.$field.val()!==""&&this.$field.val()!==undefined?this.$field.val().split(","):[50,50];const left=Math.min(this.$img.width(),(parseInt(coordinates[0],10)/100)*this.$img.width());const top=Math.min(this.$img.height(),(parseInt(coordinates[1],10)/100)*this.$img.height());this.$indicator.css("left",Math.max(0,left));this.$indicator.css("top",Math.max(0,top));this.$field.val(`${coordinates[0]},${coordinates[1]}`);};Drupal.FocalPoint.prototype.calculate=function(offsetX,offsetY){const focalPoint={};focalPoint.x=this.round((100*offsetX)/this.$img.width(),0,100);focalPoint.y=this.round((100*offsetY)/this.$img.height(),0,100);return focalPoint;};Drupal.FocalPoint.prototype.round=function(value,min,max){let roundedVal=Math.max(Math.round(value),min);roundedVal=Math.min(roundedVal,max);return roundedVal;};Drupal.FocalPoint.prototype.updatePreviewLink=function(dataSelector,value){const $previewLink=$(`a.focal-point-preview-link[data-selector=${dataSelector}]`);if($previewLink.length>0){const href=$previewLink.attr("href").split("/");href.pop();href.push(value.replace(",","x").concat($previewLink[0].search?$previewLink[0].search:""));$previewLink.attr("href",href.join("/"));}Drupal.ajax.instances.forEach(function(instance,index){if(instance&&$(instance.element).data("selector")===dataSelector){const href=$(instance.element).attr("href");Drupal.ajax.instances[index].url=href;Drupal.ajax.instances[index].options.url=href;}});};$(document).on("drupalFocalPointSet",function(event,data){data.$focalPoint.setIndicator();data.$focalPoint.updatePreviewLink(data.$focalPoint.$field.attr("data-selector"),data.$focalPoint.$field.val());});})(jQuery,Drupal);;
